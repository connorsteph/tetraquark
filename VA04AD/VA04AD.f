c-----------------------------------------------------------------------
      SUBROUTINE VA04AD(X,E,N,F,ESCALE,IPRINT,ICON,MAXIT,nfcc)
C     MINIMIZE A FUNCTION OF N VARIABLES USING CONJUGATE DIRECTIONS
C     VERSION OF 720824
C     X = 1-D ARRAY OF LENGTH N THAT CONTAINS ON INPUT THE INITIAL
C     GUESS FOR THE LOCATION OF THE MINIMUM AND ON OUTPUT THE FINAL VALUE.
C     E = 1-D ARRAY OF LENGTH N SUCH THAT E(I) IS THE DESIRED ABSOLUTE
C     ACCURACY FOR X(I). IT IS ASSUMED THAT THE E(I) ARE ROUGHLY
C     PROPORTIONAL TO THE X(I)
C     F SET TO VALUE OF FUNCTION AT MINIMUM (MAY BE INTERPOLATED)
C     ESCALE LIMITS THE LENGTH OF STEP AT EACH ITERATION SO THAT
C     X(I) IS NOT CHANGED BY MORE THAN E(I)*ESCALE AT ANY 1 STEP
C     THIS PARAMETER IS USED TO PREVENT THE SUBROUTINE MOVING AWAY
C     FROM THE REQUIRED MINIMUM AND CONVERGING TO A NEIGHBORING ONE.
C     IPRINT CONTROLS PRINTING
C     =0 ==> NO PRINTINNG
C     =1 ==> VARIABLES AND FUNCTION VALUE PRINTED AT EVERY LINE SEARCH
C     =2 ==> VARIABLES AND FUNCTION VALUE PRINTED EVERY ITERATION (I.E.
C     ONCE EVERY N+1 LINE SEARCHES)
C     ICON = 1 ==> NORMAL; ICON =2 ==> MORE THOROUGH SEARCH (30% MORE TIME)
C     MAXIT = MAXIMUM NUMBER OF ITERATIONS ALLOWED
C     REF: M.J.D. POWELL, COMPUTER JOURNAL,7,155(1965).
C     MINIMUM WILL ALMOST NEVER BE FOUND IN LESS THAN 2N**2 FUNCTION EVALS.
C     USER MUST SUPPLY SUBROUTINE CALCFX(N,X,F) WHICH SETS F TO VALUE OF
C     FUNCTION AT X.
C     RECOMMENDATIONS:
C     1) SET ESCALE AS LARGE AS POSSIBLE REEMEMBERING THAT IT SHOULD BE
C     SMALL ENOUGH TO PREVENT JUMPING FROM ONE VALLEY TO ANOTHER
C     2) CHOOSE ACCURACY SUCH THAT ESCALE > 100
C     3) IF RESULTS UNREASONABLE, TRY AGAIN WITH DIFFERENT STARTING X

      IMPLICIT REAL*8 (A-H,O-Z)
C     DIMENSIONS OF W SHOULD BE .GE. N(N+3).  CURRENTLY N SHOULD BE .LE. 8
c     jk      DIMENSION W(88),X(N),E(N)
      parameter (maxn=12,nfccmax=10000)
      DIMENSION W(maxn*(maxn+3)),X(N),E(N)

      DDMAG=0.1D0*ESCALE
      SCER=0.05D0/ESCALE
      JJ=N*N+N
      JJJ=JJ+N
      K=N+1
      NFCC=1
      IND=1
      INN=1

      DO 1 I=1,N
         DO 2 J=1,N
            W(K)=0.0D0
            IF(I-J)4,3,4
 3          W(K)=DABS(E(I))
            W(I)=ESCALE
 4          K=K+1
 2       CONTINUE
    1 CONTINUE

      ITERC=1
      ISGRAD=2
      CALL EIGEN(X,F)
      FKEEP=DABS(F)+DABS(F)
    5 ITONE=1
      FP=F
      SUM=0.0D0
      IXP=JJ

      DO 6 I=1,N
         IXP=IXP+1
         W(IXP)=X(I)
    6 CONTINUE

      IDIRN=N+1
      ILINE=1
    7 DMAX=W(ILINE)
      DACC=DMAX*SCER
      DMAG=DMIN1(DDMAG,0.1D0*DMAX)
      DMAG=DMAX1(DMAG,20.0D0*DACC)
      DDMAX=10.0D0*DMAG
      GO TO (70,70,71),ITONE
 70   DL=0.0D0
      D=DMAG
      FPREV=F
      IS=5
      FA=F
      DA=DL
    8 DD=D-DL
      DL=D
 58   K=IDIRN

      DO 9 I=1,N
         X(I)=X(I)+DD*W(K)
         K=K+1
    9 CONTINUE

      CALL EIGEN(X,F)
      NFCC=NFCC+1
      if(nfcc.ge.nfccmax) return

      GO TO (10,11,12,13,14,96),IS
 14   IF(F-FA)15,16,24
 16   IF (DABS(D)-DMAX) 17,17,18
 17   D=D+D
      GO TO 8
 18   PRINT 19
 19   FORMAT(5X,44HVA04A MAXIMUM CHANGE DOES NOT ALTER FUNCTION)
      GO TO 20
 15   FB=F
      DB=D
      GO TO 21
 24   FB=FA
      DB=DA
      FA=F
      DA=D
 21   GO TO (83,23),ISGRAD
 23   D=DB+DB-DA
      IS=1
      GO TO 8
 83   D=0.5D0*(DA+DB-(FA-FB)/(DA-DB))
      IS=4
      IF((DA-D)*(D-DB))25,8,8
 25   IS=1
      IF(DABS(D-DB)-DDMAX)8,8,26
 26   D=DB+DSIGN(DDMAX,DB-DA)
      IS=1
      DDMAX=DDMAX+DDMAX
      DDMAG=DDMAG+DDMAG
      IF(DDMAX-DMAX)8,8,27
 27   DDMAX=DMAX
      GO TO 8
 13   IF(F-FA)28,23,23
 28   FC=FB
      DC=DB
 29   FB=F
      DB=D
      GO TO 30
 12   IF(F-FB)28,28,31
 31   FA=F
      DA=D
      GO TO 30
 11   IF(F-FB)32,10,10
 32   FA=FB
      DA=DB
      GO TO 29
 71   DL=1.0D0
      DDMAX=5.0D0
      FA=FP
      DA=-1.0D0
      FB=FHOLD
      DB=0.0D0
      D=1.0D0
 10   FC=F
      DC=D
 30   A=(DB-DC)*(FA-FC)
      B=(DC-DA)*(FB-FC)
      IF((A+B)*(DA-DC))33,33,34
 33   FA=FB
      DA=DB
      FB=FC
      DB=DC
      GO TO 26
 34   D=0.5D0*(A*(DB+DC)+B*(DA+DC))/(A+B)
      DI=DB
      FI=FB
      IF(FB-FC)44,44,43
 43   DI=DC
      FI=FC
 44   GO TO (86,86,85),ITONE
 85   ITONE=2
      GO TO 45
 86   IF (DABS(D-DI)-DACC) 41,41,93
 93   IF(DABS(D-DI)-0.03D0*DABS(D)) 41,41,45
 45   IF ((DA-DC)*(DC-D)) 47,46,46
 46   FA=FB
      DA=DB
      FB=FC
      DB=DC
      GO TO 25
 47   IS=2
      IF ((DB-D)*(D-DC)) 48,8,8
 48   IS=3
      GO TO 8
 41   F=FI
      D=DI-DL
      DD=sqrt((DC-DB)*(DC-DA)*(DA-DB)/(A+B))
      DO 49 I=1,N
         X(I)=X(I)+D*W(IDIRN)
         W(IDIRN)=DD*W(IDIRN)
         IDIRN=IDIRN+1
 49   CONTINUE
      W(ILINE)=W(ILINE)/DD
      ILINE=ILINE+1
      IF(IPRINT-1)51,50,51
 50   PRINT 52,ITERC,NFCC,F,(X(I),I=1,N)
 52   FORMAT (1X,9HITERATION,I5,I10,16H FUNCTION VALUES,
     &     8X,3HF =,1p,D21.14,5(/3D24.14))
      GO TO(51,53,53),IPRINT
 51   GO TO (55,38),ITONE
 55   IF (FPREV-F-SUM) 94,95,95
 95   SUM=FPREV-F
      JIL=ILINE
 94   IF (IDIRN-JJ) 7,7,84
 84   GO TO (92,72),IND
 92   FHOLD=F
      IS=6
      IXP=JJ

      DO 59 I=1,N
         IXP=IXP+1
         W(IXP)=X(I)-W(IXP)
 59   CONTINUE

      DD=1.0D0
      GO TO 58
 96   GO TO (112,87),IND
 112  IF (FP-F) 37,37,91
 91   D=2.0D0*(FP+F-2.0D0*FHOLD)/(FP-F)**2
      IF (D*(FP-FHOLD-SUM)**2-SUM) 87,37,37
 87   J=JIL*N+1
      IF (J-JJ) 60,60,61

 60   DO 62 I=J,JJ
         K=I-N
         W(K)=W(I)
 62   CONTINUE

      DO 97 I=JIL,N
         W(I-1)=W(I)
 97   CONTINUE

 61   IDIRN=IDIRN-N
      ITONE=3
      K=IDIRN
      IXP=JJ
      AAA=0.0D0

      DO 65 I=1,N
         IXP=IXP+1
         W(K)=W(IXP)
         IF (AAA-DABS(W(K)/E(I))) 66,67,67
 66      AAA=DABS(W(K)/E(I))
 67      K=K+1
 65   CONTINUE

      DDMAG=1.0D0
      W(N)=ESCALE/AAA
      ILINE=N
      GO TO 7
 37   IXP=JJ
      AAA=0.0D0
      F=FHOLD

      DO 99 I=1,N
         IXP=IXP+1
         X(I)=X(I)-W(IXP)
         IF (AAA*DABS(E(I))-DABS(W(IXP))) 98,99,99
 98      AAA=DABS(W(IXP)/E(I))
 99   CONTINUE

      GO TO 72
 38   AAA=AAA*(1.0D0+DI)
      GO TO (72,106),IND
 72   IF (IPRINT-2) 53,50,50
 53   GO TO (109,88),IND
 109  IF(AAA-1.0D0) 89,89,76
 89   GO TO (20,116),ICON
 116  IND=2
      GO TO (100,101),INN
 100  INN=2
      K=JJJ

      DO 102 I=1,N
         K=K+1
         W(K)=X(I)
         X(I)=X(I)+10.0D0*E(I)
 102  CONTINUE

      FKEEP=F
      CALL EIGEN (N,X,F)
      NFCC=NFCC+1
      if(nfcc.ge.nfccmax) return
      DDMAG=0.0D0
      GO TO 108
 76   IF (F-FP) 35,78,78
 78   PRINT 80
 80   FORMAT (5X,37HVA04A ACCURACY LIMITED BY ERRORS IN F)
      GO TO 20
 88   IND=1
 35   DDMAG=0.4D0*sqrt(FP-F)
      ISGRAD=1
 108  ITERC=ITERC+1
      IF (ITERC-MAXIT) 5,5,81
c     jk   81 PRINT 82,MAXIT
 81   continue
 82   FORMAT(I5,30H ITERATIONS COMPLETED BY VA04A)
      IF (F-FKEEP) 20,20,110
 110  F=FKEEP

      DO 111 I=1,N
         JJJ=JJJ+1
         X(I)=W(JJJ)
 111  CONTINUE

      GO TO 20
 101  JIL=1
      FP=FKEEP
      IF (F-FKEEP) 105,78,104
 104  JIL=2
      FP=F
      F=FKEEP
 105  IXP=JJ

      DO 113 I=1,N
         IXP=IXP+1
         K=IXP+N
         GO TO (114,115),JIL
 114     W(IXP)=W(K)
         GO TO 113
 115     W(IXP)=X(I)
         X(I)=W(K)
 113  CONTINUE

      JIL=2
      GO TO 92
 106  IF(AAA-0.1D0) 20,20,107
 20   RETURN
 107  INN=1
      GO TO 35
      END
c-----------------------------------------------------------------------
